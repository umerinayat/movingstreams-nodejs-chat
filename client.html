<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Bi-directional WebSocket Chat Demo</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link href='/style.css' type='text/css' rel='stylesheet'>

  </head>
  <body lang="en">

    <ul id="messages"></ul>

    <p id="typingStatus"></p>
    <form id="chat_form" onsubmit="sendMessage(); return false;">
      <input
        type="text"
        id="message"
        name="message"
        id="message"
        placeholder="Type text to echo in here"
        value=""
        autofocus
      />
      <input type="button" id="send" value="Send!" onclick="sendMessage();" />
      <!-- <input type="button" value="Disconnect" onclick="disconnect();" /> -->
    </form>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.2/sockjs.min.js" integrity="sha512-ayb5R/nKQ3fgNrQdYynCti/n+GD0ybAhd3ACExcYvOR2J1o3HebiAe/P0oZDx5qwB+xkxuKG6Nc0AFTsPT/JDQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script>

      var sockjs = new SockJS("http://localhost:8181/chat");
      var nickname = '';

      sockjs.onopen = function (e) {
        console.log('Connection to server opened');
      };

      var messageField = document.getElementById('message');
      var typingStatus = document.getElementById('typingStatus');

      function appendLog(nickname, message) {
          var messages = document.getElementById('messages');
          var messageElem = document.createElement("li");
          var message_text = "[" + nickname + "] - " + message;
          messageElem.innerHTML = message_text;
          messages.appendChild(messageElem);
      }

      sockjs.onmessage = function (e) {
        var data = JSON.parse(e.data);
        data = data.event;
        debugger;

        nickname = data.nickname;

        if (data.type == 'typing') {
         typingStatus.innerHTML  = data.message;
        } else if (data.type == 'clear-typing') {
         typingStatus.innerHTML = '';
        } else if (data.type == 'waiting') {
          appendLog('Connecting', data.message);
        } else {
          appendLog(data.data.client.nickname, data.message);
        }

        console.log('ID: [%s] = %s', data.data.client.uuid, data.message);
      };

      sockjs.onclose = function (e) {
        appendLog('Connection closed');
        console.log('Connection closed');
        typingStatus.innerHTML = '';
      };

      function sendTyping() {
        sockjs.send(JSON.stringify({ event: 'typing' }));
      }

      function clearTyping() {
        sockjs.send(JSON.stringify({ event: 'clear-typing' }));
      }

      function sendMessage() {
          sockjs.send(
            JSON.stringify({ event: 'message', message: messageField.value })
          );
        messageField.value = '';
        messageField.focus();
        clearTyping();
      }

      messageField.addEventListener('keyup', function (event) {
        if (messageField.value.length > 0) {
          sendTyping();
        } else {
          clearTyping();
        }
      });

      function disconnect() {
        sockjs.close();
      }
    </script>
  </body>
</html>
